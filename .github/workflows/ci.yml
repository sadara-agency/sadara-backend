name: Backend CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env:
    NODE_ENV: test
    JWT_SECRET: ci-test-secret-at-least-32-characters-long-for-testing
    POSTGRES_PASSWORD: ci_test_password

jobs:
    lint-and-type-check:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: ESLint
              run: npm run lint

            - name: TypeScript compile check
              run: npx tsc --noEmit

    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: lint-and-type-check

        services:
            postgres:
                image: postgres:17
                env:
                    POSTGRES_USER: admin
                    POSTGRES_PASSWORD: ci_test_password
                    POSTGRES_DB: SadaraDB_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run tests with coverage
              run: npx jest --coverage --ci --reporters=default
              env:
                  POSTGRES_HOST: localhost
                  POSTGRES_PORT: 5432
                  POSTGRES_DB: SadaraDB_test
                  POSTGRES_USER: admin
                  POSTGRES_PASSWORD: ci_test_password

            - name: Upload coverage
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage
                  path: coverage/

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: test
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build
              run: npm run build
